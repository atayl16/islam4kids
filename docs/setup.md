# Local Development Setup

This guide will help you set up the Islam4Kids Rails application for local development. The entire stack runs in Docker, so you don't need to install Ruby, Node.js, PostgreSQL, or Redis on your host machine.

## Prerequisites

- **Docker Desktop** (v20.10 or higher)
  - macOS: [Download Docker Desktop for Mac](https://docs.docker.com/desktop/install/mac-install/)
  - Windows: [Download Docker Desktop for Windows](https://docs.docker.com/desktop/install/windows-install/)
  - Linux: [Install Docker Engine](https://docs.docker.com/engine/install/)

- **Docker Compose** (usually included with Docker Desktop)
  - Verify: `docker-compose --version`

- **Git**
  - macOS: `brew install git` or download from [git-scm.com](https://git-scm.com/)
  - Windows: Download from [git-scm.com](https://git-scm.com/)
  - Linux: `sudo apt-get install git` or equivalent

That's it! Everything else runs inside containers.

## Initial Setup

### 1. Clone the Repository

```bash
git clone https://github.com/yourusername/Islam4Kids.git
cd Islam4Kids
```

### 2. Build Docker Images

Build all services (Rails app, PostgreSQL, Redis):

```bash
bin/docker build
```

Or use docker-compose directly:

```bash
docker-compose build
```

This will:
- Build the Rails application container with Ruby 3.3+
- Pull PostgreSQL 16 image
- Pull Redis 7 image

**First build takes 5-10 minutes.** Subsequent builds are faster due to layer caching.

### 3. Start Services

Start all services in detached mode:

```bash
bin/docker up
```

Or:

```bash
docker-compose up -d
```

This starts:
- **web**: Rails app on port 3000
- **db**: PostgreSQL on port 5432
- **redis**: Redis on port 6379

Check status:

```bash
docker-compose ps
```

### 4. Create and Seed Database

Run database setup (first time only):

```bash
bin/docker db:create
bin/docker db:migrate
bin/docker db:seed
```

Or use the automated setup script:

```bash
docker-compose exec web bin/setup
```

This creates:
- PostgreSQL databases (development, test, cache, queue, cable)
- Database schema from migrations
- Seed data (default admin and user accounts)

### 5. Verify Installation

Open your browser to [http://localhost:3000](http://localhost:3000)

You should see the Islam4Kids homepage.

### 6. Log in to Admin Interface

Navigate to [http://localhost:3000/admin](http://localhost:3000/admin)

**Default credentials** (development only):
- **Admin**: `admin@islam4kids.org` / `admin123456`
- **User**: `user@islam4kids.org` / `user123456`

**IMPORTANT**: Change these credentials before deploying to production!

## Daily Development Workflow

### Starting Your Day

```bash
# Start all services
bin/docker up

# Check logs to ensure everything started
bin/docker logs
```

### Common Development Commands

The `bin/docker` script provides convenient shortcuts for common tasks:

```bash
# View logs (follow mode)
bin/docker logs

# Rails console
bin/docker console

# Run migrations
bin/docker db:migrate

# Rollback migration
bin/docker db:rollback

# Run all tests
bin/docker rspec

# Run specific test file
bin/docker rspec spec/models/story_spec.rb

# Open a shell in the container
bin/docker shell

# Restart the web service
bin/docker restart

# Stop all services
bin/docker down

# Show all available commands
bin/docker help
```

### Using docker-compose Directly

If you prefer to use docker-compose directly:

```bash
# Run Rails console
docker-compose exec web bin/rails console

# Run migrations
docker-compose exec web bin/rails db:migrate

# Run tests
docker-compose exec web bundle exec rspec

# Run specific test
docker-compose exec web bundle exec rspec spec/models/story_spec.rb

# Open shell
docker-compose exec web bash

# View logs
docker-compose logs -f web

# Restart service
docker-compose restart web

# Stop all services
docker-compose down

# Stop and remove volumes (clean slate)
docker-compose down -v
```

## Running Tests

### Full Test Suite

```bash
bin/docker rspec
```

Or:

```bash
docker-compose exec web bundle exec rspec
```

### Specific Test Files

```bash
bin/docker rspec spec/models/story_spec.rb
bin/docker rspec spec/controllers/admin/stories_controller_spec.rb
```

### With Coverage Report

Coverage is automatically generated by SimpleCov and saved to `coverage/index.html`:

```bash
bin/docker rspec
open coverage/index.html  # macOS
```

### Test Database

The test database is automatically created and maintained by RSpec. To reset it:

```bash
bin/docker db:test:prepare
```

## Code Quality Tools

### RuboCop (Linting)

Check code style:

```bash
docker-compose exec web bundle exec rubocop
```

Auto-correct offenses:

```bash
docker-compose exec web bundle exec rubocop --autocorrect-all
```

### Brakeman (Security Scanning)

Check for security vulnerabilities:

```bash
docker-compose exec web bundle exec brakeman
```

Quiet mode (only show warnings):

```bash
docker-compose exec web bundle exec brakeman --quiet
```

### Bundler Audit (Dependency Vulnerabilities)

Check for vulnerable gems:

```bash
docker-compose exec web bundle exec bundler-audit check --update
```

## Git Hooks (Optional)

Islam4Kids uses [Overcommit](https://github.com/sds/overcommit) for automated code quality checks.

### Installing Hooks

Inside the container:

```bash
docker-compose exec web overcommit --install
```

### What Gets Checked

**Pre-commit**:
- RuboCop with auto-correction

**Pre-push**:
- Brakeman security scan
- Bundler-audit dependency check

### Skipping Hooks

If you need to skip hooks temporarily:

```bash
OVERCOMMIT_DISABLE=1 git commit -m "Emergency fix"
```

**Note**: Only skip hooks when absolutely necessary.

## Working with the Database

### PostgreSQL Console

```bash
docker-compose exec db psql -U postgres -d islam4kids_development
```

Common PostgreSQL commands:

```sql
\dt              -- List tables
\d stories       -- Describe stories table
\q               -- Quit
```

### Database Reset

To start with a fresh database:

```bash
bin/docker db:reset
```

Or:

```bash
docker-compose exec web bin/rails db:drop db:create db:migrate db:seed
```

### Viewing Database with Tools

To connect with a GUI tool (TablePlus, Postico, pgAdmin):

```
Host: localhost
Port: 5432
Database: islam4kids_development
Username: postgres
Password: (check docker-compose.yml for POSTGRES_PASSWORD)
```

## Working with Redis

### Redis Console

```bash
docker-compose exec redis redis-cli
```

Common Redis commands:

```bash
KEYS *                  # List all keys
GET key_name            # Get value
FLUSHDB                 # Clear current database (careful!)
MONITOR                 # Watch all commands (Ctrl+C to exit)
```

### Clearing Cache

From Rails console:

```ruby
Rails.cache.clear
```

Or flush all Redis data:

```bash
docker-compose exec redis redis-cli FLUSHALL
```

## Troubleshooting

### Port Already in Use

If port 3000 is already in use:

```bash
# Find process using port 3000
lsof -i :3000

# Kill the process
kill -9 <PID>
```

Or change the port in [docker-compose.yml](../docker-compose.yml):

```yaml
ports:
  - "3001:3000"  # Use port 3001 instead
```

### Container Won't Start

Check logs for errors:

```bash
docker-compose logs web
```

Common issues:
- **Database not ready**: Wait a few seconds and try again
- **Port conflict**: See "Port Already in Use" above
- **Out of disk space**: Clean up Docker: `docker system prune`

### Database Connection Refused

Ensure PostgreSQL container is running:

```bash
docker-compose ps db
```

If not running:

```bash
docker-compose up -d db
```

### Migrations Failed

Check migration status:

```bash
bin/docker db:migrate:status
```

Reset database if needed:

```bash
bin/docker db:reset
```

### Tests Failing

1. Ensure test database is up to date:
   ```bash
   bin/docker db:test:prepare
   ```

2. Check for schema conflicts:
   ```bash
   docker-compose exec web bin/rails db:test:load
   ```

3. Clear test cache:
   ```bash
   docker-compose exec web bin/rails tmp:cache:clear RAILS_ENV=test
   ```

### Bundle Install Needed

If you add/remove gems:

```bash
docker-compose exec web bundle install
docker-compose restart web
```

### Complete Reset

To start completely fresh:

```bash
# Stop and remove all containers and volumes
docker-compose down -v

# Remove images
docker-compose down --rmi all

# Rebuild everything
bin/docker build
bin/docker up
bin/docker db:create db:migrate db:seed
```

## Working with Beads Issue Tracking

Islam4Kids uses [Beads](https://github.com/beadslabsio/beads) for issue tracking.

### Installing Beads CLI

Beads is already included in the Docker container. To use it on your host machine:

```bash
# macOS
brew install beadslabsio/tap/beads

# Linux/Windows (WSL)
curl -sSL https://beadslabs.io/install.sh | bash
```

### Common Beads Commands

```bash
# See what's ready to work on
bd ready

# Create a new issue
bd create "Add email validation to User model" -t task -p 1 -l models,validation

# Update issue status
bd update Islam4Kids-abc --status in_progress

# Close an issue
bd close Islam4Kids-abc --reason "Added validation with tests"

# View issue details
bd show Islam4Kids-abc

# Sync issues to git
bd sync
```

See [.claude/BEADS_CHEATSHEET.md](../.claude/BEADS_CHEATSHEET.md) for more commands.

### Viewing Issues in Admin Interface

Navigate to [http://localhost:3000/admin/beads](http://localhost:3000/admin/beads) to view issues in the web interface.

## Development Tips

### Live Reloading

Rails automatically reloads code changes. Just refresh your browser.

If changes aren't appearing:
1. Check logs: `bin/docker logs`
2. Restart server: `bin/docker restart`

### Running One-Off Commands

```bash
# Any Rails command
docker-compose exec web bin/rails <command>

# Any Rake task
docker-compose exec web bin/rails <task>

# Any Ruby script
docker-compose exec web ruby script.rb
```

### Debugging with Byebug

Add `debugger` or `byebug` to your code:

```ruby
def index
  debugger  # Execution will pause here
  @stories = Story.all
end
```

Attach to the running container:

```bash
docker-compose attach web
```

Press `Ctrl+P, Ctrl+Q` to detach without stopping the container.

### Viewing Logs

```bash
# All services
docker-compose logs -f

# Just Rails
bin/docker logs

# Last 100 lines
docker-compose logs --tail=100 web

# Since specific time
docker-compose logs --since 2024-01-01T00:00:00 web
```

### Cleaning Up

Remove stopped containers:

```bash
docker-compose rm
```

Remove unused images:

```bash
docker image prune
```

Remove everything (careful!):

```bash
docker system prune -a --volumes
```

## Next Steps

- Read [architecture.md](architecture.md) to understand the system design
- Read [contributing.md](contributing.md) for coding guidelines
- Check [ROADMAP.md](../ROADMAP.md) for planned features
- Browse existing issues: `bd ready`

## Getting Help

- **Rails Guides**: https://guides.rubyonrails.org/
- **Rails API**: https://api.rubyonrails.org/
- **Project Issues**: Run `bd list` or visit `/admin/beads`
- **Docker Issues**: Check logs with `docker-compose logs`
